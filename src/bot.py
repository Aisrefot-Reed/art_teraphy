"""
Telegram Bot Process for Art Therapist
This bot receives photos from users, analyzes emotions, and provides art therapy recommendations.
"""

import asyncio
import logging
import os
import aiohttp
from aiogram import Bot, Dispatcher, types
from aiogram.filters import CommandStart, Command
from aiogram.types import Message, BufferedInputFile
from aiogram.utils.keyboard import InlineKeyboardBuilder
from dotenv import load_dotenv
import requests
import json

# Load environment variables
load_dotenv()

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Bot configuration
BOT_TOKEN = os.getenv('BOT_TOKEN')
ML_API_URL = os.getenv('ML_API_URL', 'http://localhost:8001')
LLM_API_URL = os.getenv('LLM_API_URL')
LLM_API_KEY = os.getenv('LLM_API_KEY')

if not BOT_TOKEN:
    raise ValueError("BOT_TOKEN environment variable is required")

# Initialize bot and dispatcher
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# Art therapy recommendations based on emotions
EMOTION_PROMPTS = {
    'angry': """ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¸ÑÐ¿Ñ‹Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð³Ð½ÐµÐ². ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ ÐµÐ¼Ñƒ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ¸ Ð°Ñ€Ñ‚-Ñ‚ÐµÑ€Ð°Ð¿Ð¸Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð³Ð½ÐµÐ²Ð¾Ð¼. 
    Ð’ÐºÐ»ÑŽÑ‡Ð¸ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ: Ñ€Ð¸ÑÐ¾Ð²Ð°Ð½Ð¸Ðµ Ð°Ð±ÑÑ‚Ñ€Ð°ÐºÑ‚Ð½Ñ‹Ñ… Ñ„Ð¾Ñ€Ð¼, Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ ÐºÑ€Ð°ÑÐ½Ñ‹Ð¼ Ñ†Ð²ÐµÑ‚Ð¾Ð¼, ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð»Ð»Ð°Ð¶ÐµÐ¹ Ð´Ð»Ñ Ð²Ñ‹Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ ÑÐ¼Ð¾Ñ†Ð¸Ð¹. 
    ÐžÑ‚Ð²ÐµÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÑŽÑ‰Ð¸Ð¼, Ð¿Ð¾Ð½Ð¸Ð¼Ð°ÑŽÑ‰Ð¸Ð¼ Ð¸ Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡Ð½Ñ‹Ð¼. Ð”Ð»Ð¸Ð½Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ð°: 150-200 ÑÐ»Ð¾Ð².""",
    
    'disgust': """ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¸ÑÐ¿Ñ‹Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ð¸Ð»Ð¸ Ð½ÐµÐ¿Ñ€Ð¸ÑÑ‚Ð¸Ðµ. ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ¸ Ð°Ñ€Ñ‚-Ñ‚ÐµÑ€Ð°Ð¿Ð¸Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ ÑÑ‚Ð¸Ð¼Ð¸ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð°Ð¼Ð¸.
    Ð’ÐºÐ»ÑŽÑ‡Ð¸ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ Ð¿Ð¾ Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð½ÐµÐ³Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð², Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ Ñ‚ÐµÐºÑÑ‚ÑƒÑ€Ð°Ð¼Ð¸, ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ñ‰Ð¸Ñ‚Ð½Ñ‹Ñ… ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð².
    ÐžÑ‚Ð²ÐµÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð´ÐµÐ»Ð¸ÐºÐ°Ñ‚Ð½Ñ‹Ð¼ Ð¸ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÑŽÑ‰Ð¸Ð¼. Ð”Ð»Ð¸Ð½Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ð°: 150-200 ÑÐ»Ð¾Ð².""",
    
    'fear': """ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¸ÑÐ¿Ñ‹Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ ÑÑ‚Ñ€Ð°Ñ… Ð¸Ð»Ð¸ Ñ‚Ñ€ÐµÐ²Ð¾Ð³Ñƒ. ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ ÑƒÑÐ¿Ð¾ÐºÐ°Ð¸Ð²Ð°ÑŽÑ‰Ð¸Ðµ Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ¸ Ð°Ñ€Ñ‚-Ñ‚ÐµÑ€Ð°Ð¿Ð¸Ð¸.
    Ð’ÐºÐ»ÑŽÑ‡Ð¸ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ: Ñ€Ð¸ÑÐ¾Ð²Ð°Ð½Ð¸Ðµ Ð¼Ð°Ð½Ð´Ð°Ð», Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ Ð¼ÑÐ³ÐºÐ¸Ð¼Ð¸ Ñ†Ð²ÐµÑ‚Ð°Ð¼Ð¸, ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ð¸ Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹.
    ÐžÑ‚Ð²ÐµÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ÑƒÑÐ¿Ð¾ÐºÐ°Ð¸Ð²Ð°ÑŽÑ‰Ð¸Ð¼ Ð¸ Ð²ÑÐµÐ»ÑÑŽÑ‰Ð¸Ð¼ ÑƒÐ²ÐµÑ€ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ. Ð”Ð»Ð¸Ð½Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ð°: 150-200 ÑÐ»Ð¾Ð².""",
    
    'happy': """ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¸ÑÐ¿Ñ‹Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ñ€Ð°Ð´Ð¾ÑÑ‚ÑŒ! ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ¸ Ð°Ñ€Ñ‚-Ñ‚ÐµÑ€Ð°Ð¿Ð¸Ð¸ Ð´Ð»Ñ ÑƒÑÐ¸Ð»ÐµÐ½Ð¸Ñ Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð·Ð¸Ñ‚Ð¸Ð²Ð½Ñ‹Ñ… ÑÐ¼Ð¾Ñ†Ð¸Ð¹.
    Ð’ÐºÐ»ÑŽÑ‡Ð¸ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ: ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÑ€ÐºÐ¸Ñ… ÐºÐ¾Ð»Ð»Ð°Ð¶ÐµÐ¹, Ñ€Ð¸ÑÐ¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¾Ð»Ð½ÐµÑ‡Ð½Ñ‹Ñ… Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð², Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ Ñ‚ÐµÐ¿Ð»Ñ‹Ð¼Ð¸ Ñ†Ð²ÐµÑ‚Ð°Ð¼Ð¸.
    ÐžÑ‚Ð²ÐµÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²Ð»ÑÑŽÑ‰Ð¸Ð¼ Ð¸ ÑÐ½ÐµÑ€Ð³Ð¸Ñ‡Ð½Ñ‹Ð¼. Ð”Ð»Ð¸Ð½Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ð°: 150-200 ÑÐ»Ð¾Ð².""",
    
    'sad': """ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¸ÑÐ¿Ñ‹Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð³Ñ€ÑƒÑÑ‚ÑŒ. ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð¼ÑÐ³ÐºÐ¸Ðµ Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ¸ Ð°Ñ€Ñ‚-Ñ‚ÐµÑ€Ð°Ð¿Ð¸Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð¿ÐµÑ‡Ð°Ð»ÑŒÑŽ.
    Ð’ÐºÐ»ÑŽÑ‡Ð¸ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ: Ñ€Ð¸ÑÐ¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð¾Ð¶Ð´Ñ Ð¸ ÐµÐ³Ð¾ Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð² Ñ€Ð°Ð´ÑƒÐ³Ñƒ, Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ ÑÐ¸Ð½Ð¸Ð¼Ð¸ Ð¾Ñ‚Ñ‚ÐµÐ½ÐºÐ°Ð¼Ð¸, ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸.
    ÐžÑ‚Ð²ÐµÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ÑÐ¾Ñ‡ÑƒÐ²ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¼ Ð¸ Ð¾Ð±Ð½Ð°Ð´ÐµÐ¶Ð¸Ð²Ð°ÑŽÑ‰Ð¸Ð¼. Ð”Ð»Ð¸Ð½Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ð°: 150-200 ÑÐ»Ð¾Ð².""",
    
    'surprise': """ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¸ÑÐ¿Ñ‹Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ ÑƒÐ´Ð¸Ð²Ð»ÐµÐ½Ð¸Ðµ. ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ¸ Ð°Ñ€Ñ‚-Ñ‚ÐµÑ€Ð°Ð¿Ð¸Ð¸ Ð´Ð»Ñ Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ Ð½Ð¾Ð²Ñ‹Ñ… ÑÐ¼Ð¾Ñ†Ð¸Ð¹.
    Ð’ÐºÐ»ÑŽÑ‡Ð¸ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ: ÑÐºÑÐ¿ÐµÑ€Ð¸Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ Ð½Ð¾Ð²Ñ‹Ð¼Ð¸ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ð°Ð¼Ð¸, ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½ÐµÐ¾Ð¶Ð¸Ð´Ð°Ð½Ð½Ñ‹Ñ… Ñ†Ð²ÐµÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ñ‡ÐµÑ‚Ð°Ð½Ð¸Ð¹.
    ÐžÑ‚Ð²ÐµÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð»ÑŽÐ±Ð¾Ð¿Ñ‹Ñ‚Ð½Ñ‹Ð¼ Ð¸ Ð¿Ð¾Ð¾Ñ‰Ñ€ÑÑŽÑ‰Ð¸Ð¼ Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ. Ð”Ð»Ð¸Ð½Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ð°: 150-200 ÑÐ»Ð¾Ð².""",
    
    'neutral': """ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ Ð² Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ð¾Ð¼ ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾Ð¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¸. ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ¸ Ð°Ñ€Ñ‚-Ñ‚ÐµÑ€Ð°Ð¿Ð¸Ð¸ Ð´Ð»Ñ ÑÐ°Ð¼Ð¾Ð¿Ð¾Ð·Ð½Ð°Ð½Ð¸Ñ.
    Ð’ÐºÐ»ÑŽÑ‡Ð¸ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ: ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾Ðµ Ñ€Ð¸ÑÐ¾Ð²Ð°Ð½Ð¸Ðµ, ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð°Ð²Ñ‚Ð¾Ð¿Ð¾Ñ€Ñ‚Ñ€ÐµÑ‚Ð¾Ð², Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ð¼Ð¸ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ð°Ð¼Ð¸ Ð´Ð»Ñ Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ñ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÐµÐ³Ð¾ Ð¼Ð¸Ñ€Ð°.
    ÐžÑ‚Ð²ÐµÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¼ÑÐ³ÐºÐ¾ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÑÑŽÑ‰Ð¸Ð¼ Ð¸ Ð¿Ð¾Ð¾Ñ‰Ñ€ÑÑŽÑ‰Ð¸Ð¼ ÑÐ°Ð¼Ð¾Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ. Ð”Ð»Ð¸Ð½Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ð°: 150-200 ÑÐ»Ð¾Ð²."""
}

async def call_llm_api(prompt: str) -> str:
    """
    Call LLM API to generate art therapy recommendations
    
    Args:
        prompt: The prompt for the LLM
        
    Returns:
        Generated recommendation text
    """
    if not LLM_API_URL or not LLM_API_KEY:
        # Fallback to predefined responses if no LLM API is configured
        return generate_fallback_response(prompt)
    
    try:
        async with aiohttp.ClientSession() as session:
            headers = {
                'Authorization': f'Bearer {LLM_API_KEY}',
                'Content-Type': 'application/json'
            }
            
            data = {
                'model': 'gpt-3.5-turbo',  # or another model
                'messages': [
                    {'role': 'system', 'content': 'Ð¢Ñ‹ Ð¾Ð¿Ñ‹Ñ‚Ð½Ñ‹Ð¹ Ð°Ñ€Ñ‚-Ñ‚ÐµÑ€Ð°Ð¿ÐµÐ²Ñ‚, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ Ð»ÑŽÐ´ÑÐ¼ Ñ‡ÐµÑ€ÐµÐ· Ñ‚Ð²Ð¾Ñ€Ñ‡ÐµÑÑ‚Ð²Ð¾.'},
                    {'role': 'user', 'content': prompt}
                ],
                'max_tokens': 300,
                'temperature': 0.7
            }
            
            async with session.post(LLM_API_URL, headers=headers, json=data) as response:
                if response.status == 200:
                    result = await response.json()
                    return result['choices'][0]['message']['content']
                else:
                    logger.error(f"LLM API error: {response.status}")
                    return generate_fallback_response(prompt)
                    
    except Exception as e:
        logger.error(f"Error calling LLM API: {e}")
        return generate_fallback_response(prompt)

def generate_fallback_response(prompt: str) -> str:
    """Generate fallback response when LLM API is not available"""
    if 'Ð³Ð½ÐµÐ²' in prompt.lower() or 'angry' in prompt.lower():
        return """Ð¯ Ð²Ð¸Ð¶Ñƒ, Ñ‡Ñ‚Ð¾ Ð²Ñ‹ Ð¸ÑÐ¿Ñ‹Ñ‚Ñ‹Ð²Ð°ÐµÑ‚Ðµ ÑÐ¸Ð»ÑŒÐ½Ñ‹Ðµ ÑÐ¼Ð¾Ñ†Ð¸Ð¸. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ñ‚ÐµÑ…Ð½Ð¸ÐºÑƒ "Ð’Ñ‹Ð¿Ð»ÐµÑÐº Ð³Ð½ÐµÐ²Ð° Ð½Ð° Ð±ÑƒÐ¼Ð°Ð³Ðµ":

ðŸŽ¨ Ð’Ð¾Ð·ÑŒÐ¼Ð¸Ñ‚Ðµ Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ Ð»Ð¸ÑÑ‚ Ð±ÑƒÐ¼Ð°Ð³Ð¸ Ð¸ ÑÑ€ÐºÐ¸Ðµ ÐºÑ€Ð°ÑÐºÐ¸ (Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ ÐºÑ€Ð°ÑÐ½Ñ‹Ð¹, Ð¾Ñ€Ð°Ð½Ð¶ÐµÐ²Ñ‹Ð¹)
âœï¸ Ð Ð¸ÑÑƒÐ¹Ñ‚Ðµ Ñ€ÐµÐ·ÐºÐ¸Ð¼Ð¸, ÑÐ½ÐµÑ€Ð³Ð¸Ñ‡Ð½Ñ‹Ð¼Ð¸ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸ÑÐ¼Ð¸ - Ð»Ð¸Ð½Ð¸Ð¸, Ð¿ÑÑ‚Ð½Ð°, Ð°Ð±ÑÑ‚Ñ€Ð°ÐºÑ‚Ð½Ñ‹Ðµ Ñ„Ð¾Ñ€Ð¼Ñ‹
ðŸ–Œï¸ ÐÐµ Ð´ÑƒÐ¼Ð°Ð¹Ñ‚Ðµ Ð¾ ÐºÑ€Ð°ÑÐ¾Ñ‚Ðµ, Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð²Ñ‹Ñ€Ð°Ð¶Ð°Ð¹Ñ‚Ðµ ÑÐ²Ð¾Ð¸ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð° Ñ‡ÐµÑ€ÐµÐ· Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ðµ ÐºÐ¸ÑÑ‚Ð¸
âš¡ ÐŸÐ¾ÑÐ»Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ, Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ñ‚Ðµ Ð½Ð° Ñ€Ð¸ÑÑƒÐ½Ð¾Ðº Ð¸ Ð¿Ð¾Ð´ÑƒÐ¼Ð°Ð¹Ñ‚Ðµ, Ñ‡Ñ‚Ð¾ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¾ÑÑŒ Ð² Ð²Ð°ÑˆÐ¸Ñ… Ð¾Ñ‰ÑƒÑ‰ÐµÐ½Ð¸ÑÑ…

Ð­Ñ‚Ð¾ Ð¿Ð¾Ð¼Ð¾Ð¶ÐµÑ‚ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ Ð²Ñ‹Ñ€Ð°Ð·Ð¸Ñ‚ÑŒ Ð³Ð½ÐµÐ² Ð¸ Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐµÐ³Ð¾ Ð² Ñ‚Ð²Ð¾Ñ€Ñ‡ÐµÑÐºÑƒÑŽ ÑÐ½ÐµÑ€Ð³Ð¸ÑŽ."""

    elif 'ÑÑ‚Ñ€Ð°Ñ…' in prompt.lower() or 'fear' in prompt.lower():
        return """Ð¯ Ð¿Ð¾Ð½Ð¸Ð¼Ð°ÑŽ, Ñ‡Ñ‚Ð¾ Ð²Ñ‹ Ñ‡ÑƒÐ²ÑÑ‚Ð²ÑƒÐµÑ‚Ðµ Ñ‚Ñ€ÐµÐ²Ð¾Ð³Ñƒ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑƒÑÐ¿Ð¾ÐºÐ°Ð¸Ð²Ð°ÑŽÑ‰ÑƒÑŽ Ñ‚ÐµÑ…Ð½Ð¸ÐºÑƒ "ÐœÐ°Ð½Ð´Ð°Ð»Ð° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸":

ðŸŒ¸ ÐÐ°Ñ€Ð¸ÑÑƒÐ¹Ñ‚Ðµ ÐºÑ€ÑƒÐ³ Ð² Ñ†ÐµÐ½Ñ‚Ñ€Ðµ Ð»Ð¸ÑÑ‚Ð°
ðŸŽ¨ Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ ÐµÐ³Ð¾ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÑŽÑ‰Ð¸Ð¼Ð¸ÑÑ ÑƒÐ·Ð¾Ñ€Ð°Ð¼Ð¸, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ Ð¼ÑÐ³ÐºÐ¸Ðµ Ñ†Ð²ÐµÑ‚Ð° (Ð³Ð¾Ð»ÑƒÐ±Ð¾Ð¹, Ð·ÐµÐ»ÐµÐ½Ñ‹Ð¹, Ñ„Ð¸Ð¾Ð»ÐµÑ‚Ð¾Ð²Ñ‹Ð¹)
âœ¨ Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð°ÑÑÐ¾Ñ†Ð¸Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ Ñƒ Ð²Ð°Ñ Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒÑŽ Ð¸ Ð¿Ð¾ÐºÐ¾ÐµÐ¼
ðŸ•¯ï¸ Ð Ð¸ÑÑƒÐ¹Ñ‚Ðµ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ð¾, ÐºÐ¾Ð½Ñ†ÐµÐ½Ñ‚Ñ€Ð¸Ñ€ÑƒÑÑÑŒ Ð½Ð° Ð´Ñ‹Ñ…Ð°Ð½Ð¸Ð¸

Ð­Ñ‚Ð° Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ° Ð¿Ð¾Ð¼Ð¾Ð¶ÐµÑ‚ ÑƒÑÐ¿Ð¾ÐºÐ¾Ð¸Ñ‚ÑŒ ÑƒÐ¼ Ð¸ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¾Ñ‰ÑƒÑ‰ÐµÐ½Ð¸Ðµ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÐµÐ¹ ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸."""

    elif 'Ð³Ñ€ÑƒÑÑ‚ÑŒ' in prompt.lower() or 'sad' in prompt.lower():
        return """Ð¯ Ñ‡ÑƒÐ²ÑÑ‚Ð²ÑƒÑŽ Ð²Ð°ÑˆÑƒ Ð¿ÐµÑ‡Ð°Ð»ÑŒ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ñ‚ÐµÑ…Ð½Ð¸ÐºÑƒ "ÐžÑ‚ Ð´Ð¾Ð¶Ð´Ñ Ðº Ñ€Ð°Ð´ÑƒÐ³Ðµ":

ðŸ’§ ÐÐ°Ñ‡Ð½Ð¸Ñ‚Ðµ Ñ Ñ€Ð¸ÑÐ¾Ð²Ð°Ð½Ð¸Ñ Ð´Ð¾Ð¶Ð´Ñ ÑÐ¸Ð½Ð¸Ð¼Ð¸ Ð¸ ÑÐµÑ€Ñ‹Ð¼Ð¸ Ñ†Ð²ÐµÑ‚Ð°Ð¼Ð¸
â˜ï¸ Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð·Ð¸Ñ‚Ðµ Ñ‚ÑƒÑ‡Ð¸, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¸Ð·Ð¸Ñ€ÑƒÑŽÑ‚ Ð²Ð°ÑˆÐ¸ Ð³Ñ€ÑƒÑÑ‚Ð½Ñ‹Ðµ Ð¼Ñ‹ÑÐ»Ð¸
ðŸŒˆ ÐŸÐ¾ÑÑ‚ÐµÐ¿ÐµÐ½Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ ÑÑ€ÐºÐ¸Ðµ Ñ†Ð²ÐµÑ‚Ð°, ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ Ñ€Ð°Ð´ÑƒÐ³Ñƒ
â˜€ï¸ Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚Ðµ ÑÐ¾Ð»Ð½Ñ†ÐµÐ¼, Ð¿Ñ€Ð¾Ð±Ð¸Ð²Ð°ÑŽÑ‰Ð¸Ð¼ÑÑ ÑÐºÐ²Ð¾Ð·ÑŒ Ð¾Ð±Ð»Ð°ÐºÐ°

Ð­Ñ‚Ð¾Ñ‚ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð¿Ð¾Ð¼Ð¾Ð¶ÐµÑ‚ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ñ€Ð¾Ð¹Ñ‚Ð¸ Ñ‡ÐµÑ€ÐµÐ· Ð³Ñ€ÑƒÑÑ‚ÑŒ Ðº Ð½Ð°Ð´ÐµÐ¶Ð´Ðµ Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÑŽ."""

    else:
        return """Ð¢Ð²Ð¾Ñ€Ñ‡ÐµÑÑ‚Ð²Ð¾ - ÑÑ‚Ð¾ Ð¿Ñ€ÐµÐºÑ€Ð°ÑÐ½Ñ‹Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð± Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ²Ð¾Ð¸ ÑÐ¼Ð¾Ñ†Ð¸Ð¸. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ñ‚ÐµÑ…Ð½Ð¸ÐºÑƒ "Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð¾Ðµ Ð²Ñ‹Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ":

ðŸŽ¨ Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð²Ð°Ñ Ð¿Ñ€Ð¸Ð²Ð»ÐµÐºÐ°ÑŽÑ‚ (ÐºÑ€Ð°ÑÐºÐ¸, ÐºÐ°Ñ€Ð°Ð½Ð´Ð°ÑˆÐ¸, Ð¿Ð°ÑÑ‚ÐµÐ»ÑŒ)
âœ¨ ÐÐ°Ñ‡Ð½Ð¸Ñ‚Ðµ Ñ€Ð¸ÑÐ¾Ð²Ð°Ñ‚ÑŒ Ð±ÐµÐ· ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð¹ Ñ†ÐµÐ»Ð¸, ÑÐ»ÐµÐ´ÑƒÑ ÑÐ²Ð¾Ð¸Ð¼ Ð¸Ð¼Ð¿ÑƒÐ»ÑŒÑÐ°Ð¼
ðŸŒˆ ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑŒÑ‚Ðµ Ñ†Ð²ÐµÑ‚Ð°Ð¼ Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ð¼ Ð¿Ð¾ÑÐ²Ð»ÑÑ‚ÑŒÑÑ ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾
ðŸ’­ ÐÐµ ÑÑƒÐ´Ð¸Ñ‚Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚, Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð½Ð°ÑÐ»Ð°Ð¶Ð´Ð°Ð¹Ñ‚ÐµÑÑŒ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð¼

ÐŸÐ¾Ð¼Ð½Ð¸Ñ‚Ðµ: Ð² Ð°Ñ€Ñ‚-Ñ‚ÐµÑ€Ð°Ð¿Ð¸Ð¸ Ð²Ð°Ð¶ÐµÐ½ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ, Ð° Ð½Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚. Ð’Ð°ÑˆÐ¸ ÑÐ¼Ð¾Ñ†Ð¸Ð¸ Ð¸Ð¼ÐµÑŽÑ‚ Ð¿Ñ€Ð°Ð²Ð¾ Ð½Ð° Ð²Ñ‹Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ."""

@dp.message(CommandStart())
async def command_start_handler(message: Message) -> None:
    """Handle /start command"""
    welcome_text = """
ðŸŽ¨ Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð±Ð¾Ñ‚ "ÐÑ€Ñ‚-Ð¢ÐµÑ€Ð°Ð¿ÐµÐ²Ñ‚"! 

Ð¯ Ð¿Ð¾Ð¼Ð¾Ð³Ñƒ Ð²Ð°Ð¼ Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ²Ð¾Ð¸ ÑÐ¼Ð¾Ñ†Ð¸Ð¸ Ñ‡ÐµÑ€ÐµÐ· Ñ‚Ð²Ð¾Ñ€Ñ‡ÐµÑÑ‚Ð²Ð¾. ÐŸÑ€Ð¾ÑÑ‚Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð¼Ð½Ðµ Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸ÑŽ ÑÐ²Ð¾ÐµÐ³Ð¾ Ñ€Ð¸ÑÑƒÐ½ÐºÐ°, ÐºÐ°Ñ€Ñ‚Ð¸Ð½Ñ‹ Ð¸Ð»Ð¸ Ð´Ð°Ð¶Ðµ ÑÐµÐ»Ñ„Ð¸, Ð¸ Ñ Ð¿Ñ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÑŽ Ð²Ð°ÑˆÐµ ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¸ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ñƒ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ¸ Ð°Ñ€Ñ‚-Ñ‚ÐµÑ€Ð°Ð¿Ð¸Ð¸.

ðŸ“¸ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ñ„Ð¾Ñ‚Ð¾, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ!
â“ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ /help Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸.
"""
    await message.answer(welcome_text)

@dp.message(Command("help"))
async def command_help_handler(message: Message) -> None:
    """Handle /help command"""
    help_text = """
ðŸ†˜ ÐšÐ°Ðº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒÑÑ Ð±Ð¾Ñ‚Ð¾Ð¼:

1ï¸âƒ£ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸ÑŽ:
   â€¢ Ð’Ð°Ñˆ Ñ€Ð¸ÑÑƒÐ½Ð¾Ðº Ð¸Ð»Ð¸ ÐºÐ°Ñ€Ñ‚Ð¸Ð½Ñƒ
   â€¢ Ð¡ÐµÐ»Ñ„Ð¸ (Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° ÑÐ¼Ð¾Ñ†Ð¸Ð¹ Ð¿Ð¾ Ð»Ð¸Ñ†Ñƒ)
   â€¢ Ð›ÑŽÐ±Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ð¾Ñ‚Ñ€Ð°Ð¶Ð°ÐµÑ‚ Ð²Ð°ÑˆÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ

2ï¸âƒ£ ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ Ð°Ð½Ð°Ð»Ð¸Ð· ÑÐ¼Ð¾Ñ†Ð¸Ð¹ Ð¸ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ Ð°Ñ€Ñ‚-Ñ‚ÐµÑ€Ð°Ð¿Ð¸Ð¸

3ï¸âƒ£ Ð¡Ð»ÐµÐ´ÑƒÐ¹Ñ‚Ðµ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð½Ñ‹Ð¼ Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ°Ð¼ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ ÑÐ¼Ð¾Ñ†Ð¸ÑÐ¼Ð¸

ðŸŽ¨ ÐÑ€Ñ‚-Ñ‚ÐµÑ€Ð°Ð¿Ð¸Ñ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚:
   â€¢ Ð’Ñ‹Ñ€Ð°Ð·Ð¸Ñ‚ÑŒ ÑÐ»Ð¾Ð¶Ð½Ñ‹Ðµ ÑÐ¼Ð¾Ñ†Ð¸Ð¸
   â€¢ Ð¡Ð½Ð¸Ð·Ð¸Ñ‚ÑŒ ÑÑ‚Ñ€ÐµÑÑ Ð¸ Ñ‚Ñ€ÐµÐ²Ð¾Ð³Ñƒ
   â€¢ Ð›ÑƒÑ‡ÑˆÐµ Ð¿Ð¾Ð½ÑÑ‚ÑŒ ÑÐµÐ±Ñ
   â€¢ ÐÐ°Ð¹Ñ‚Ð¸ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ðµ Ñ€ÐµÑÑƒÑ€ÑÑ‹

ðŸ’¡ Ð¡Ð¾Ð²ÐµÑ‚: ÐÐµ Ð±ÐµÑÐ¿Ð¾ÐºÐ¾Ð¹Ñ‚ÐµÑÑŒ Ð¾ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ðµ Ñ€Ð¸ÑÑƒÐ½ÐºÐ° - Ð²Ð°Ð¶ÐµÐ½ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ, Ð° Ð½Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚!
"""
    await message.answer(help_text)

@dp.message(lambda message: message.photo)
async def handle_photo(message: Message) -> None:
    """Handle photo messages"""
    try:
        # Send "typing" action
        await bot.send_chat_action(message.chat.id, "typing")
        
        # Get the largest photo
        photo = message.photo[-1]
        
        # Download photo
        file_info = await bot.get_file(photo.file_id)
        file_data = await bot.download_file(file_info.file_path)
        
        # Send photo to ML API for emotion analysis
        async with aiohttp.ClientSession() as session:
            data = aiohttp.FormData()
            data.add_field('file', file_data, filename='photo.jpg', content_type='image/jpeg')
            
            async with session.post(f"{ML_API_URL}/analyze_emotion", data=data) as response:
                if response.status == 200:
                    emotion_result = await response.json()
                    
                    if emotion_result['status'] == 'success':
                        dominant_emotion = emotion_result['dominant_emotion']
                        confidence = emotion_result['confidence']
                        
                        # Generate prompt for LLM
                        prompt = EMOTION_PROMPTS.get(dominant_emotion, EMOTION_PROMPTS['neutral'])
                        
                        # Get art therapy recommendation
                        recommendation = await call_llm_api(prompt)
                        
                        # Format response
                        response_text = f"""
ðŸŽ­ **ÐÐ½Ð°Ð»Ð¸Ð· ÑÐ¼Ð¾Ñ†Ð¸Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!**

ðŸ“Š Ð”Ð¾Ð¼Ð¸Ð½Ð¸Ñ€ÑƒÑŽÑ‰Ð°Ñ ÑÐ¼Ð¾Ñ†Ð¸Ñ: **{dominant_emotion.upper()}**
ðŸ“ˆ Ð£Ð²ÐµÑ€ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ: {confidence:.2%}

ðŸŽ¨ **ÐŸÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ Ð°Ñ€Ñ‚-Ñ‚ÐµÑ€Ð°Ð¿Ð¸Ð¸:**

{recommendation}

ðŸ’¡ ÐŸÐ¾Ð¼Ð½Ð¸Ñ‚Ðµ: Ñ‚Ð²Ð¾Ñ€Ñ‡ÐµÑÑ‚Ð²Ð¾ - ÑÑ‚Ð¾ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÑ‚Ð²Ð¾ Ð´Ð»Ñ Ð²Ñ‹Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð»ÑŽÐ±Ñ‹Ñ… ÑÐ¼Ð¾Ñ†Ð¸Ð¹!
"""
                        
                        await message.answer(response_text, parse_mode="Markdown")
                        
                    else:
                        # No face detected
                        await message.answer("""
ðŸ˜Š Ð¯ Ð½Ðµ ÑÐ¼Ð¾Ð³ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ ÑÐ¼Ð¾Ñ†Ð¸Ð¸ Ð½Ð° ÑÑ‚Ð¾Ð¼ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¸, Ð½Ð¾ ÑÑ‚Ð¾ Ð½Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð°!

ðŸŽ¨ **Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ¸ Ð°Ñ€Ñ‚-Ñ‚ÐµÑ€Ð°Ð¿Ð¸Ð¸:**

ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ñ‚ÐµÑ…Ð½Ð¸ÐºÑƒ "Ð˜Ð½Ñ‚ÑƒÐ¸Ñ‚Ð¸Ð²Ð½Ð¾Ðµ Ñ€Ð¸ÑÐ¾Ð²Ð°Ð½Ð¸Ðµ":
â€¢ Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ†Ð²ÐµÑ‚Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð²Ð°Ñ ÑÐµÐ¹Ñ‡Ð°Ñ Ð¿Ñ€Ð¸Ð²Ð»ÐµÐºÐ°ÑŽÑ‚
â€¢ Ð Ð¸ÑÑƒÐ¹Ñ‚Ðµ Ð°Ð±ÑÑ‚Ñ€Ð°ÐºÑ‚Ð½Ñ‹Ðµ Ñ„Ð¾Ñ€Ð¼Ñ‹, ÑÐ»ÐµÐ´ÑƒÑ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ð¼ Ð¸Ð¼Ð¿ÑƒÐ»ÑŒÑÐ°Ð¼  
â€¢ ÐÐµ Ð´ÑƒÐ¼Ð°Ð¹Ñ‚Ðµ Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ðµ, ÑÐ¾ÑÑ€ÐµÐ´Ð¾Ñ‚Ð¾Ñ‡ÑŒÑ‚ÐµÑÑŒ Ð½Ð° Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ
â€¢ ÐŸÐ¾ÑÐ»Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð¿Ð¾Ð´ÑƒÐ¼Ð°Ð¹Ñ‚Ðµ, Ñ‡Ñ‚Ð¾ Ð²Ñ‹ Ñ‡ÑƒÐ²ÑÑ‚Ð²ÑƒÐµÑ‚Ðµ

Ð¢Ð²Ð¾Ñ€Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ Ð»ÑƒÑ‡ÑˆÐµ Ð¿Ð¾Ð½ÑÑ‚ÑŒ ÑÐµÐ±Ñ Ð´Ð°Ð¶Ðµ Ð±ÐµÐ· Ð°Ð½Ð°Ð»Ð¸Ð·Ð° ÑÐ¼Ð¾Ñ†Ð¸Ð¹! ðŸŒˆ
""")
                else:
                    await message.answer("âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð°Ð½Ð°Ð»Ð¸Ð·Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·.")
                    
    except Exception as e:
        logger.error(f"Error processing photo: {e}")
        await message.answer("âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ð¸. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·.")

@dp.message()
async def handle_other_messages(message: Message) -> None:
    """Handle other messages"""
    await message.answer("""
ðŸ“¸ ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸ÑŽ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° ÑÐ¼Ð¾Ñ†Ð¸Ð¹!

Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ:
â€¢ Ð¡Ð²Ð¾Ð¹ Ñ€Ð¸ÑÑƒÐ½Ð¾Ðº Ð¸Ð»Ð¸ ÐºÐ°Ñ€Ñ‚Ð¸Ð½Ñƒ
â€¢ Ð¡ÐµÐ»Ñ„Ð¸ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° ÑÐ¼Ð¾Ñ†Ð¸Ð¹ Ð¿Ð¾ Ð»Ð¸Ñ†Ñƒ
â€¢ Ð›ÑŽÐ±Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ, Ð¾Ñ‚Ñ€Ð°Ð¶Ð°ÑŽÑ‰ÐµÐµ Ð²Ð°ÑˆÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ

Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ /help Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸.
""")

async def main() -> None:
    """Main function to run the bot"""
    logger.info("Starting Art Therapist Bot...")
    
    # Check if ML API is available
    try:
        async with aiohttp.ClientSession() as session:
            async with session.get(f"{ML_API_URL}/health") as response:
                if response.status == 200:
                    logger.info("ML API is available")
                else:
                    logger.warning("ML API is not responding properly")
    except Exception as e:
        logger.error(f"Cannot connect to ML API: {e}")
        logger.warning("Bot will continue without ML API (limited functionality)")
    
    # Start polling
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())

